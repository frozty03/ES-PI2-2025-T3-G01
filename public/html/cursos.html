<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/public/assets/css/cursoStyle.css"> 
    <link rel="icon" type="img/png" href="/public/assets/img/LogoNotaDez.svg">
    <title>Cursos - NotaDez</title>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/public/assets/img/LogoNotaDez.svg" alt="Logo NotaDez">
                <h2>NotaDez</h2>
            </div>
            <div class="user-profile">
                <span class="user-label">Usuário:</span>
                <span id="user-name">Carregando...</span>
            </div>
            <nav class="sidebar-nav" id="sidebar-nav">
                <h3>Instituições:</h3>
                </nav>
        </aside>

        <main class="main-content">
            <div class="content-card">
                <header class="content-header">
                    <h1 id="main-title">Carregando...</h1>
                    <button class="btn-cadastrar" id="open-add-modal-btn">Cadastrar</button>
                </header>
                <section class="courses-grid" id="courses-grid">
                    </section>
            </div>
        </main>
    </div>

    <div id="add-course-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-add-modal-btn">&times;</span>
            <h2>Cadastrar Novo Curso</h2>
            <form id="add-course-form">
                <div class="input-box">
                    <label for="course-name">Nome do Curso:</label>
                    <input type="text" id="course-name" placeholder="Digite o nome" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="cancel-add-btn">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <h2>Confirmar Exclusão</h2>
            <p>Você tem certeza que deseja excluir o curso "<span id="course-to-delete-name"></span>"?</p>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" id="cancel-delete-btn">Cancelar</button>
                <button type="button" class="btn-confirm-delete" id="confirm-delete-btn">Excluir</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
    const userNameSpan = document.getElementById('user-name');
    const mainTitle = document.getElementById('main-title');
    const addModal = document.getElementById('add-course-modal');
    const deleteModal = document.getElementById('delete-confirm-modal');
    const coursesGrid = document.getElementById('courses-grid');
    const sidebarNav = document.getElementById('sidebar-nav');

    // Dados de exemplo (simulando o que viria do backend)
    const dbData = {
        institutions: [
            { 
                id: 1, nome: 'aaa', 
                courses: [
                    { id: 10, nome: 'xxx' },
                    { id: 11, nome: 'yyy' },
                    { id: 12, nome: 'zzz' }
                ],
                disciplines: [
                    {id: 100, nome: 'xxx'}, {id: 101, nome: 'yyy'}
                ],
                turmas: [
                    {id: 1000, nome: '1'}, {id: 1001, nome: '2'}
                ]
            },
            { id: 2, nome: 'bbb', courses: [{ id: 20, nome: '+++' }] },
            { id: 3, nome: 'ccc', courses: [] }
        ]
    };
    
    let currentInstitution;
    let courses = [];


    function getInstitutionFromURL() {
        const params = new URLSearchParams(window.location.search);
        const id = parseInt(params.get('inst_id')); 
        
        if (!id) {
            currentInstitution = dbData.institutions[0];
            console.warn("ID da instituição não encontrado na URL, usando fallback.");
        } else {
            currentInstitution = dbData.institutions.find(inst => inst.id === id);
            
            if (!currentInstitution) {
                console.warn("ID da URL não encontrado no DB, usando fallback.");
                currentInstitution = dbData.institutions[0];
            }
        }
        
        courses = currentInstitution.courses || [];
    }

    function displayUserName() {
        const userName = localStorage.getItem('user_nome');
        userNameSpan.textContent = userName || 'Visitante';
    }

    function displayMainTitle() {
        mainTitle.textContent = `Cursos de ${currentInstitution.nome}`;
    }


    function renderSidebar() {
        const ul = document.createElement('ul');
        
        dbData.institutions.forEach(inst => {
            const li = document.createElement('li');
            li.dataset.id = inst.id;

            if (inst.id === currentInstitution.id) {
                li.classList.add('institution-item');
                li.innerHTML = `
                    <span>${inst.nome}</span>
                    <h4>Cursos:</h4>
                    <ul>
                        ${(inst.courses || []).map(c => `<li>${c.nome}</li>`).join('')}
                        ${(inst.courses || []).length === 0 ? '<li>Nenhum curso</li>' : ''}
                    </ul>
                    <h4>Disciplinas:</h4>
                    <ul>
                        ${(inst.disciplines || []).map(d => `<li>${d.nome}</li>`).join('')}
                        ${(inst.disciplines || []).length === 0 ? '<li>Nenhuma disciplina</li>' : ''}
                    </ul>
                     <h4>Turmas:</h4>
                    <ul>
                        ${(inst.turmas || []).map(t => `<li>${t.nome}</li>`).join('')}
                        ${(inst.turmas || []).length === 0 ? '<li>Nenhuma turma</li>' : ''}
                    </ul>
                `;
            } else {
                li.innerHTML = `<span>${inst.nome}</span>`;
            }
            ul.appendChild(li);
        });
        sidebarNav.appendChild(ul);
    }

    function renderCourseGrid() {
        coursesGrid.innerHTML = ''; 

        courses.forEach(course => {
            const card = document.createElement('div');
            card.className = 'course-card';
            card.dataset.id = course.id;
            card.innerHTML = `
                <span class="card-name">${course.nome}</span>
                <div class="card-options">
                    <button class="options-btn">⋮</button>
                    <div class="options-menu">
                        <button class="rename-btn">Renomear</button>
                        <button class="delete-btn">Excluir</button>
                    </div>
                </div>
            `;
            coursesGrid.appendChild(card);
        });
    }

    function renderAll() {
        renderSidebar();
        renderCourseGrid();
    }


    function addCourse(name) {
        const newId = courses.length > 0 ? Math.max(...courses.map(c => c.id)) + 1 : 1;
        courses.push({ id: newId, nome: name });
        
        sidebarNav.innerHTML = '<h3>Instituições:</h3>'; 
        renderAll();
    }

    function deleteCourse(id) {
        courses = courses.filter(course => course.id !== id);
        
        sidebarNav.innerHTML = '<h3>Instituições:</h3>'; 
        renderAll();
    }


    function showModal(modal) {
        modal.style.display = 'flex';
    }

    function hideModal(modal) {
        modal.style.display = 'none';
    }

    document.getElementById('open-add-modal-btn').addEventListener('click', () => {
        showModal(addModal);
    });

    document.getElementById('close-add-modal-btn').addEventListener('click', () => hideModal(addModal));
    document.getElementById('cancel-add-btn').addEventListener('click', () => hideModal(addModal));

    document.getElementById('add-course-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('course-name');
        if (input.value.trim()) {
            addCourse(input.value.trim());
            input.value = '';
            hideModal(addModal);
        }
    });
    
    coursesGrid.addEventListener('click', (e) => {
        if (e.target.classList.contains('options-btn')) {
            const menu = e.target.nextElementSibling;
            document.querySelectorAll('.options-menu').forEach(m => {
                if(m !== menu) m.style.display = 'none';
            });
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        if (e.target.classList.contains('delete-btn')) {
            const card = e.target.closest('.course-card');
            const id = parseInt(card.dataset.id);
            const course = courses.find(c => c.id === id);

            document.getElementById('course-to-delete-name').textContent = course.nome;
            deleteModal.dataset.id = id; 
            showModal(deleteModal);
        }
    });

    document.getElementById('cancel-delete-btn').addEventListener('click', () => hideModal(deleteModal));
    
    document.getElementById('confirm-delete-btn').addEventListener('click', () => {
        const idToDelete = parseInt(deleteModal.dataset.id);
        deleteCourse(idToDelete);
        hideModal(deleteModal);
    });

    sidebarNav.addEventListener('click', (e) => {
        const li = e.target.closest('li');
        if (li && li.dataset.id) {
            const id = parseInt(li.dataset.id);
            if (id !== currentInstitution.id) {
                const inst = dbData.institutions.find(i => i.id === id);
                window.location.href = `/html/cursos.html?inst_id=${id}&inst_name=${inst.nome}`;
            }
        }
    });


    getInstitutionFromURL();
    displayUserName();
    displayMainTitle();
    renderAll();
});
    </script>
</body>
</html>