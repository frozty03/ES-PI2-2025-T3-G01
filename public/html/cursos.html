<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/assets/css/cursoStyle.css"> 
    <link rel="icon" type="img/png" href="/assets/img/LogoNotaDez.svg">
    <title>Cursos - NotaDez</title>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/assets/img/LogoNotaDez.svg" alt="Logo NotaDez">
                <h1><span class="title-nota">Nota</span><span class="title-dez">Dez</span></h1>
            </div>
            <div class="user-profile">
                <span class="user-label">Usuário:</span>
                <span id="user-name">Carregando...</span>
            </div>
            <nav class="sidebar-nav" id="sidebar-nav">
                <h3>Instituições:</h3>
                </nav>
        </aside>

        <main class="main-content">
            <div class="content-card">
                <header class="content-header">
                    <h1 id="main-title">Carregando...</h1>
                    <button class="btn-cadastrar" id="open-add-modal-btn">Cadastrar</button>
                </header>
                <section class="courses-grid" id="courses-grid">
                    </section>
            </div>
        </main>
    </div>

    <div id="add-course-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-add-modal-btn">&times;</span>
            <h2>Cadastrar Novo Curso</h2>
            <form id="add-course-form">
                <div class="input-box">
                    <label for="course-name">Nome do Curso:</label>
                    <input type="text" id="course-name" placeholder="Digite o nome" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="cancel-add-btn">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <h2>Confirmar Exclusão</h2>
            <p>Você tem certeza que deseja excluir o curso "<span id="course-to-delete-name"></span>"?</p>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" id="cancel-delete-btn">Cancelar</button>
                <button type="button" class="btn-confirm-delete" id="confirm-delete-btn">Excluir</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
        // --- ELEMENTOS DO DOM ---
        const userNameSpan = document.getElementById('user-name');
        const mainTitle = document.getElementById('main-title');
        const addModal = document.getElementById('add-course-modal');
        const deleteModal = document.getElementById('delete-confirm-modal');
        const coursesGrid = document.getElementById('courses-grid');
        const sidebarNav = document.getElementById('sidebar-nav'); // Onde a lista da sidebar entra

        // --- CONFIGURAÇÕES ---
        const API_URL = 'http://localhost:3000'; 
        const userId = localStorage.getItem('user_id'); // Pega o ID salvo no login
        const userName = localStorage.getItem('user_nome');
        
        // Pega o ID e Nome da instituição da URL (ex: cursos.html?inst_id=123&inst_name=PUC)
        const params = new URLSearchParams(window.location.search);
        const currentInstId = params.get('inst_id'); 
        const currentInstName = params.get('inst_name') || 'Instituição';

        let coursesList = []; // Array local para armazenar os cursos carregados

        // --- INICIALIZAÇÃO BÁSICA ---
        function init() {
            if (!userId) {
                alert('Usuário não logado!');
                window.location.href = '/index.html'; // Redireciona se não tiver user
                return;
            }
            
            if (!currentInstId) {
                alert('Nenhuma instituição selecionada.');
                window.location.href = '/html/instituicoes.html'; // Volta pra lista
                return;
            }

            userNameSpan.textContent = userName || 'Usuário';
            mainTitle.textContent = `Cursos de ${currentInstName}`;

            // Carrega os dados
            fetchSidebarInstitutions();
            fetchCourses();
        }

        // --- 1. CARREGAR SIDEBAR (LISTA DE INSTITUIÇÕES) ---
        // Precisamos buscar as instituições para montar o menu lateral
        async function fetchSidebarInstitutions() {
            try {
                const res = await fetch(`${API_URL}/instituicoes/user/${userId}`);
                if (!res.ok) throw new Error('Erro ao carregar sidebar');
                
                const data = await res.json();
                const institutions = data.instituicoes || [];
                renderSidebar(institutions);
            } catch (error) {
                console.error(error);
                sidebarNav.innerHTML = '<p style="color:white; padding:10px;">Erro ao carregar menu.</p>';
            }
        }

        function renderSidebar(institutions) {
            sidebarNav.innerHTML = '<h3>Instituições:</h3>';
            const ul = document.createElement('ul');
            
            institutions.forEach(inst => {
                const li = document.createElement('li');
                li.dataset.id = inst.id;
                
                // Se for a instituição atual da página, destaca ela
                if (inst.id === currentInstId) {
                    li.classList.add('institution-item');
                    li.innerHTML = `
                        <span style="color: #FCC61D;">${inst.nome}</span>
                        `;
                } else {
                    li.innerHTML = `<span>${inst.nome}</span>`;
                    // Clique para navegar para outra instituição
                    li.addEventListener('click', () => {
                        window.location.href = `/html/cursos.html?inst_id=${inst.id}&inst_name=${inst.nome}`;
                    });
                }
                ul.appendChild(li);
            });
            sidebarNav.appendChild(ul);
        }

        // --- 2. CARREGAR CURSOS (GRID PRINCIPAL) ---
        async function fetchCourses() {
            try {
                // Rota: GET /cursos/instituicao/:idInst/user/:idUser
                const res = await fetch(`${API_URL}/cursos/instituicao/${currentInstId}/user/${userId}`);
                
                if (!res.ok) {
                     // Se der 404 pode ser que não tenha cursos ainda, então tratamos como vazio
                     if(res.status === 404) {
                        coursesList = [];
                        renderCourseGrid();
                        return;
                     }
                     throw new Error('Erro ao buscar cursos');
                }

                coursesList = await res.json(); // O backend retorna ListarCursoDto[]
                renderCourseGrid();

            } catch (error) {
                console.error(error);
                coursesGrid.innerHTML = '<p>Não foi possível carregar os cursos.</p>';
            }
        }

        function renderCourseGrid() {
            coursesGrid.innerHTML = ''; 

            if (coursesList.length === 0) {
                coursesGrid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding-top: 50px;">
                <p>Nenhum curso cadastrado nesta instituição.</p>
                </div>`;
                return;
            }

            coursesList.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.dataset.id = course.id; // ID do UUID
                card.innerHTML = `
                    <span class="card-name">${course.nome}</span>
                    <div class="card-options">
                        <button class="options-btn">⋮</button>
                        <div class="options-menu">
                            <button class="rename-btn">Renomear</button>
                            <button class="delete-btn">Excluir</button>
                        </div>
                    </div>
                `;
                coursesGrid.appendChild(card);
            });
        }

        // --- 3. CRIAR CURSO (POST) ---
        async function createCourse(name) {
            try {
                const payload = {
                    nome: name,
                    instituicoesIds: [currentInstId] // O DTO pede um array de IDs
                };

                const res = await fetch(`${API_URL}/cursos/user/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error('Erro ao criar curso');

                // Recarrega a lista
                await fetchCourses(); 

            } catch (error) {
                console.error(error);
                alert('Erro ao salvar o curso. Verifique o console.');
            }
        }

        // --- 4. DELETAR CURSO (DELETE) ---
        async function deleteCourse(courseId) {
            try {
                // ATENÇÃO: Certifique-se que no Controller a rota é @Delete(':id/user/:userId')
                const res = await fetch(`${API_URL}/cursos/${courseId}/user/${userId}`, {
                    method: 'DELETE'
                });

                if (!res.ok) throw new Error('Erro ao excluir');

                // Remove da lista local e re-renderiza para evitar nova chamada de rede (opcional)
                coursesList = coursesList.filter(c => c.id !== courseId);
                renderCourseGrid();

            } catch (error) {
                console.error(error);
                alert('Erro ao excluir curso.');
            }
        }

        // --- GESTÃO DE MODAIS E EVENTOS (Igual ao original, mas chamando as funções async) ---

        function showModal(modal) { modal.style.display = 'flex'; }
        function hideModal(modal) { modal.style.display = 'none'; }

        // Modal Adicionar
        document.getElementById('open-add-modal-btn').addEventListener('click', () => showModal(addModal));
        document.getElementById('close-add-modal-btn').addEventListener('click', () => hideModal(addModal));
        document.getElementById('cancel-add-btn').addEventListener('click', () => hideModal(addModal));

        document.getElementById('add-course-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('course-name');
            if (input.value.trim()) {
                await createCourse(input.value.trim());
                input.value = '';
                hideModal(addModal);
            }
        });
        
        // Lógica de clique nos Cards (Opções e Delete)
        coursesGrid.addEventListener('click', (e) => {
            // Abrir menu
            if (e.target.classList.contains('options-btn')) {
                const menu = e.target.nextElementSibling;
                // Fecha outros menus abertos
                document.querySelectorAll('.options-menu').forEach(m => {
                    if(m !== menu) m.style.display = 'none';
                });
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            }

            // Clicar em Excluir
            if (e.target.classList.contains('delete-btn')) {
                const card = e.target.closest('.course-card');
                const id = card.dataset.id; 
                const course = coursesList.find(c => c.id === id);

                if(course) {
                    document.getElementById('course-to-delete-name').textContent = course.nome;
                    deleteModal.dataset.id = id; 
                    showModal(deleteModal);
                }
            }
        });

        // Fechar menu se clicar fora
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.card-options')) {
                document.querySelectorAll('.options-menu').forEach(m => m.style.display = 'none');
            }
        });

        // Modal Deletar
        document.getElementById('cancel-delete-btn').addEventListener('click', () => hideModal(deleteModal));
        
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            const idToDelete = deleteModal.dataset.id;
            if(idToDelete) {
                await deleteCourse(idToDelete);
            }
            hideModal(deleteModal);
        });

        // Roda a inicialização
        init();
    });
    </script>
</body>
</html>