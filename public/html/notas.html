<!-- Desenvolvido por Miguel Afonso Castro de Almeida -->
<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Notas da Turma</title>
        <link rel="stylesheet" href="../assets/css/styleNotas.css">
        <style>
            .tabela-notas { width: 100%; border-collapse: collapse; margin-top: 1rem; }
            .tabela-notas th, .tabela-notas td { border: 1px solid #ccc; padding: 0.7rem; text-align: center; }
            .tabela-notas th { background: #3338A0; color: #fff; font-weight: 600; }
            .tabela-notas td input[type='number'] { width: 65px; text-align: right; border-radius: 5px; border: 1px solid #b0b3c1; }
            .media-final { font-weight: bold; }
            .header-actions { display: flex; align-items: center; gap: 2rem; }
        </style>
    </head>
    <body>
    <div class="container">
        <aside class="sidebar">
        <div class="sidebar-header">
            <img src="/assets/img/LogoNotaDez.svg" alt="Logo NotaDez">
            <h1><span class="title-nota">Nota</span><span class="title-dez">Dez</span></h1>
        </div>
        <div class="user-profile">
            <span class="user-label">Usuário:</span>
            <span id="user-name">Carregando...</span>
        </div>
        <nav class="sidebar-nav" id="sidebar-nav">
            <h3>Instituições:</h3>
            <ul id="institutions-list"></ul>
        </nav>
        </aside>
        <main class="main-content">
        <div class="content-card">
            <header class="content-header header-actions">
            <label>
                <input type="checkbox" id="media-ponderada-checkbox" checked>
                Média ponderada
            </label>
            <button id="open-add-modal-btn" class="btn-cadastrar">Cadastrar aluno</button>
            </header>

            <div style="overflow-x:auto;">
                <table id="tabela-notas" class="tabela-notas">
                    <thead>
                        <tr id="thead-notas">
                            <!-- cabeçalho -->
                        </tr>
                    </thead>
                    <tbody id="tbody-notas">
                        <!-- corpo -->
                    </tbody>
                </table>
            </div>
        </div>
        </main>
    </div>

    <div id="add-aluno-modal" class="modal">
        <div class="modal-content">
        <span class="close-btn" id="close-add-modal-btn">&times;</span>
        <h2>Cadastrar Novo Aluno</h2>
        <form id="add-aluno-form">
            <div class="input-box">
            <label for="aluno-nome">Nome do aluno:</label>
            <input type="text" id="aluno-nome" required maxlength="150">
            </div>
            <div class="input-box">
            <label for="aluno-ra">RA do aluno (8 caracteres):</label>
            <input type="text" id="aluno-ra" required maxlength="8" minlength="8" pattern=".{8,8}">
            </div>
            <div class="modal-actions">
            <button type="button" class="btn-cancel" id="cancel-add-btn">Cancelar</button>
            <button type="submit" class="btn-confirm">Salvar</button>
            </div>
        </form>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:3000';
        const userId = localStorage.getItem('user_id');
        let turmaId = '';
        let disciplinaId = '';

        document.getElementById('user-name').textContent = localStorage.getItem('user_nome') || 'Visitante';

        async function loadNotasInterface() {
            const params = new URLSearchParams(window.location.search);
            turmaId = params.get('turma_id');
            disciplinaId = params.get('disciplina_id');
            const { alunos, componentes } = await fetch(
                `${API_BASE}/notas/turma/${turmaId}/disciplina/${disciplinaId}`
            ).then(r => r.json());

            document.getElementById('thead-notas').innerHTML = renderTableHead(componentes);
            document.getElementById('tbody-notas').innerHTML = renderTableBody(alunos, componentes, document.getElementById('media-ponderada-checkbox').checked);
        }

        function renderTableHead(componentes) {
            return `
                <tr>
                    <th>Nome</th>
                    <th>RA</th>
                    ${componentes.map(c => `<th>${c.sigla}</th>`).join('')}
                    <th>Média final</th>
                </tr>
            `;
        }

        function renderTableBody(alunos, componentes, ponderada) {
            return alunos.map(aluno => {
                let medias = [];
                let celulas = componentes.map(comp => {
                    const nota = aluno.notas[comp.sigla];
                    medias.push({ valor: Number(nota), peso: Number(comp.peso) });
                    return `<td>
                        <input type="number" step="0.01" min="0" max="10"
                            class="input-nota"
                            data-aluno="${aluno.id}"
                            data-comp="${comp.id}"
                            value="${nota !== null && nota !== undefined ? nota : ''}"
                        >
                    </td>`;
                });
                const media = calcularMedia(medias, ponderada);
                return `
                    <tr>
                        <td>${aluno.nome}</td>
                        <td>${aluno.ra}</td>
                        ${celulas.join('')}
                        <td><span class="media-final">${media}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function calcularMedia(medias, ponderada) {
            if (!medias.length) return '-';
            let soma = 0, somaPesos = 0;
            for (const m of medias) {
                if (!isNaN(m.valor)) {
                    soma += ponderada ? m.valor * m.peso : m.valor;
                    somaPesos += ponderada ? m.peso : 1;
                }
            }
            if (!somaPesos) return '-';
            return (soma / somaPesos).toFixed(2);
        }

        document.getElementById('media-ponderada-checkbox').addEventListener('change', () => {
            loadNotasInterface();
        });

        document.getElementById('open-add-modal-btn').addEventListener('click', () => {
            document.getElementById('add-aluno-modal').style.display = 'flex';
        });
        document.getElementById('close-add-modal-btn').addEventListener('click', () => {
            document.getElementById('add-aluno-modal').style.display = 'none';
        });
        document.getElementById('cancel-add-btn').addEventListener('click', () => {
            document.getElementById('add-aluno-modal').style.display = 'none';
        });

        document.getElementById('add-aluno-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('aluno-nome').value;
            const ra = document.getElementById('aluno-ra').value;
            if (ra.length !== 8) {
                alert('O RA deve ter exatamente 8 caracteres!');
                return;
            }
            if (nome.length < 1 || nome.length > 150) {
                alert('O nome deve ter entre 1 e 150 caracteres!');
                return;
            }
            const resp = await fetch(`${API_BASE}/alunos/user/${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome, ra, turmaIds: [turmaId] })
            });
            if (!resp.ok) {
                const data = await resp.json();
                alert(data.message || 'Erro ao cadastrar aluno!');
                return;
            }
            document.getElementById('add-aluno-modal').style.display = 'none';
            loadNotasInterface();
        });

        document.getElementById('tabela-notas').addEventListener('change', async (e) => {
            if (e.target.classList.contains('input-nota')) {
                const idAluno = e.target.dataset.aluno;
                const idComp = e.target.dataset.comp;
                const valor = parseFloat(e.target.value);
                await fetch(`${API_BASE}/notas/lancar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idAluno,
                        idComponenteNota: idComp,
                        valor,
                        idTurma: turmaId
                    })
                });
                loadNotasInterface();
            }
        });

        fetch(`${API_BASE}/instituicoes/user/${userId}`)
            .then(res => res.json())
            .then(data => {
                const ul = document.getElementById('institutions-list');
                ul.innerHTML = '';
                (data.instituicoes || []).forEach(inst => {
                    const li = document.createElement('li');
                    li.textContent = inst.nome;
                    li.dataset.id = inst.id;
                    li.className = "institution-item";
                    li.style.cursor = "pointer";
                    li.onclick = () => window.location.href = `/html/cursos.html?inst_id=${inst.id}`;
                    ul.appendChild(li);
                });
            });

        loadNotasInterface();
    </script>

    </body>
</html>
